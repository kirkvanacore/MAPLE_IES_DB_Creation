---
title: "IES-assessment_aggregation"
author: "Jieun Lee"
date: "10/1/2020"
output: html_document
---

# updates 
- 
```{r global_options, include=FALSE}
# set global chunk options...  
knitr::opts_chunk$set(comment     = "",
                      echo        = TRUE, 
                      comment     = FALSE,
                      warning     = FALSE, 
                      message     = FALSE)
```

```{r, echo=FALSE, results=FALSE, warning=FALSE, message=FALSE}
### ----- load package(s) ----- ###

library("tidyverse")    
library("forcats")
library("lubridate")    
library("readxl")
library("reshape2")
library("data.table")
library("dplyr")
library("readr")

library("psych")        
library("furniture")    
library("stargazer")    
library("pander")
library("writexl")

panderOptions('digits', 3)
panderOptions('round', 3)
panderOptions('keep.trailing.zeros', TRUE)
```


### Reading in the data files 
```{r}
# assessment data 
assessment_raw <- read.csv("ies_dataset_2021_0527.csv")

# master file (roster)
final_roster <- read_excel("finalrosters_allstudents_2021_04_25_updated.xlsx")

# problem id
assessmemt_problem_id <- read_excel("assessment_problem_id_forsyth_2020.xlsx")
```


### cleaning the assessment raw file 
```{r}
# Deleting unnecessary columns 
assessment  <- assessment_raw  %>% select(-'type', -'school_id', -'teacher_id', -'teacher', -'classroom', -'full_name', -'first_name', -'last_name', -'class_section', -'assignment_start', -'assignment_end', -'problem_log_id', -'student_xref', -'problem_set_id', -'alias', -'assistments_user_id.1')
```


### cleaning the master file
```{r}
# changing the variable name 
names(final_roster)[names(final_roster) == "Student_ID"] <- "student_id"

# Selecting columns 
final_roster  <- final_roster  %>% select('student_number', 'student_id', 'Condition Assignment')
```

### adding the problem number info
```{r}
assessment <- inner_join(assessment, assessmemt_problem_id, by = "question_id")
```


### subsetting the data
```{r}
pre_test <- assessment[ which(assessment$assignment=="INTRO_SURVEY"), ]

mid_test <- assessment[ which(assessment$assignment=="COMMON_MID"), ]

post_test <- assessment[ which(assessment$assignment=="CLOSING_SURVEY"), ]

delayed_test <- assessment[ which(assessment$assignment=="POSTTEST"),]
```



###### Reshaping the pre-assessment data #######

### subsetting
```{r}
pre_math <- pre_test[ which(pre_test$problem_num %in% 
                      c("01_02_P", "01_03_F", "01_04_C", 
                        "01_06_F", "01_07_P", "01_08_C", 
                        "01_09_C", "01_11_P", 
                        "01_12_F", "01_13_C")), ]
```

### PRETEST- correctness (item level)
```{r}
pre_math_score <- dcast(pre_math, 
                 student_id ~ problem_num, 
                 value.var = "correct", 
                 fun.aggregate = sum, na.rm = FALSE)

setnames(pre_math_score, old=c("01_02_P", "01_03_F", "01_04_C", 
                        "01_06_F", "01_07_P", "01_08_C", 
                        "01_09_C", "01_11_P", 
                        "01_12_F", "01_13_C"), 
         
         new=c("correct.01_02_P", "correct.01_03_F", "correct.01_04_C", 
               "correct.01_06_F", "correct.01_07_P", "correct.01_08_C", 
               "correct.01_09_C", "correct.01_11_P", 
               "correct.01_12_F", "correct.01_13_C"), 
                skip_absent=TRUE)
```


### PRETEST- math performance 
```{r}
pre_math_score <- pre_math_score %>%
    mutate(pre.total_math_score = (correct.01_02_P + correct.01_03_F + 
                               correct.01_04_C + correct.01_06_F + 
                               correct.01_07_P + correct.01_08_C + 
                               correct.01_09_C + correct.01_11_P +
                               correct.01_12_F + correct.01_13_C),
         
           pre.percentage_math_score = (pre.total_math_score/10)*100,

           pre.sub_P_score = (correct.01_02_P + correct.01_07_P + correct.01_11_P),
         
           pre.sub_C_score = (correct.01_04_C + correct.01_08_C +
                              correct.01_09_C + correct.01_13_C),
         
           pre.sub_F_score = (correct.01_03_F + correct.01_06_F + correct.01_12_F)) 
```

# PRETEST- Completion &  Time taken
```{r}
pre_time <- dcast(pre_test, 
                  student_id ~ problem_num, 
                  value.var = "estimated_time_on_task", 
                  fun.aggregate = sum, na.rm = FALSE)

pre_time[pre_time == 0] <- NA

pre_time <- pre_time %>% select("student_id", "01_02_P", "01_03_F", "01_04_C", 
                        "01_06_F", "01_07_P", "01_08_C", 
                        "01_09_C", "01_11_P", 
                        "01_12_F", "01_13_C")

setnames(pre_time, old=c("01_02_P", "01_03_F", "01_04_C", 
                        "01_06_F", "01_07_P", "01_08_C", 
                        "01_09_C", "01_11_P", 
                        "01_12_F", "01_13_C"), 
         
         new=c("time_on_task.01_02_P", "time_on_task.01_03_F", "time_on_task.01_04_C", 
               "time_on_task.01_06_F", "time_on_task.01_07_P", "time_on_task.01_08_C", 
               "time_on_task.01_09_C", "time_on_task.01_11_P", 
               "time_on_task.01_12_F", "time_on_task.01_13_C"), skip_absent=TRUE)

pre_time <- pre_time %>%
  mutate(pre.math_completed_num = rowSums(pre_time[,2:11] !="", na.rm=TRUE),
         
         pre.math_completed_percent = pre.math_completed_num/10*100,
         
         pre.total_time_on_tasks = as.numeric(apply(pre_time[,2:11], 1, sum, na.rm=TRUE)),
         
         pre.avg_time_on_tasks = pre.total_time_on_tasks/pre.math_completed_num)

```

# PRETEST- math anxiety (item level)
```{r}
# subsetting MA score 
pre_MA <- pre_test[ which(pre_test$problem_id.x=="PRABKM8Y"), ]

pre_MA_01 <- pre_MA[ which(pre_MA$problem_num %in%
                    c('MA_15_NR','MA_16_NR', 'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W')), ]

pre_MA_02 <- pre_MA[ which(pre_MA$problem_num %in% c('MA_17_NC', 'MA_18_NC', 'MA_19_NC')), ]

# recoding 
pre_MA_01$answer_text[pre_MA_01$answer_text=="No"] <- "0"
pre_MA_01$answer_text[pre_MA_01$answer_text=="Not really"] <- "1"
pre_MA_01$answer_text[pre_MA_01$answer_text=="Kind of"] <- "2"
pre_MA_01$answer_text[pre_MA_01$answer_text=="Yes"] <- "3"

pre_MA_01$answer_text <- as.numeric(as.character(pre_MA_01$answer_text))

# recoding (reverse scoring)
pre_MA_02$answer_text[pre_MA_02$answer_text=="No"] <- "3"
pre_MA_02$answer_text[pre_MA_02$answer_text=="Not really"] <- "2"
pre_MA_02$answer_text[pre_MA_02$answer_text=="Kind of"] <- "1"
pre_MA_02$answer_text[pre_MA_02$answer_text=="Yes"] <- "0"

pre_MA_02$answer_text <- as.numeric(as.character(pre_MA_02$answer_text))

pre_MA_merge <- rbind(pre_MA_01, pre_MA_02)
```

# PRETEST- math anxiety scores 
```{r}
# wide to long 

pre_MA_score <- dcast(pre_MA_merge, 
                      student_id ~ problem_num, 
                      value.var = "answer_text", 
                      fun.aggregate = sum, na.rm = FALSE)

setnames(pre_MA_score, old=c('MA_15_NR','MA_16_NR', 'MA_17_NC', 'MA_18_NC', 'MA_19_NC',
                             'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W'), 
         
         new=c('pr_MA_15_NR','pr_MA_16_NR', 'pr_MA_17_NC', 'pr_MA_18_NC', 'pr_MA_19_NC',
               'pr_MA_20_W', 'pr_MA_21_W', 'pr_MA_22_NR', 'pr_MA_23_W'),
         
         skip_absent=TRUE)


# calculation 
pre_MA_score <- pre_MA_score %>%
  mutate(pre.MA_total_score = as.numeric(apply(pre_MA_score[,2:10], 1, sum)),
         
         pre.MA_avg_score = pre.MA_total_score/9,
         
         pre.negative_reaction_score = pr_MA_15_NR + pr_MA_16_NR + pr_MA_22_NR,
         
         pre.numerical_confindence_score = pr_MA_17_NC + pr_MA_18_NC + pr_MA_19_NC,
         
         pre.worry_score = pr_MA_20_W + pr_MA_21_W + pr_MA_23_W)
```


# PRETEST- math self-efficacy (item level)
```{r}
# subsetting MSE score 
pre_MSE <- pre_test[ which(pre_test$problem_id.x=="PRABKM8Z"), ]

# recoding 
pre_MSE$answer_text[pre_MSE$answer_text=="Never"] <- "0"
pre_MSE$answer_text[pre_MSE$answer_text=="Very rarely"] <- "1"
pre_MSE$answer_text[pre_MSE$answer_text=="Rarely"] <- "2"
pre_MSE$answer_text[pre_MSE$answer_text=="Often"] <- "3"
pre_MSE$answer_text[pre_MSE$answer_text=="Very often"] <- "4"
pre_MSE$answer_text[pre_MSE$answer_text=="Very Often"] <- "4"
pre_MSE$answer_text[pre_MSE$answer_text=="Always"] <- "5"

pre_MSE$answer_text <- as.numeric(as.character(pre_MSE$answer_text))
```

# PRETEST- math self-efficacy scores 
```{r}
# wide to long 
pre_MSE_score <- dcast(pre_MSE, 
                       student_id ~ problem_num, 
                       value.var = "answer_text", 
                       fun.aggregate = sum, na.rm = FALSE)

setnames(pre_MSE_score, old=c("MSE_24", "MSE_25", "MSE_26", "MSE_27", "MSE_28"), 
         
         new=c("pr_MSE_24",	"pr_MSE_25",	"pr_MSE_26",	"pr_MSE_27",	
               "pr_MSE_28"),
         
         skip_absent=TRUE)


pre_MSE_score <- pre_MSE_score %>%
          mutate(pre.MSE_total_score = pr_MSE_24 + pr_MSE_25 + pr_MSE_26 + 
                                       pr_MSE_27 + pr_MSE_28, 
                   
                 pre.MSE_avg_score = pre.MSE_total_score/5)

```


# PRETEST- PS tasks 
```{r}
### subsetting PS tasks 
pre_PS_tasks_1_1 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test1"), ]
pre_PS_tasks_1_3 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test3"), ]
pre_PS_tasks_1_5 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test5"), ]
pre_PS_tasks_1_7 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test7"), ]
pre_PS_tasks_1_8 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test8"), ]
pre_PS_tasks_1_9 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test9"), ]
pre_PS_tasks_1_13 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test13"), ]
pre_PS_tasks_1_16 <- pre_test[ which(pre_test$task_name=="PS_Part1_Test16"), ]

pre_PS_tasks_2E_1 <- pre_test[ which(pre_test$task_part =="T1P2E" & pre_test$task_name=="PS_T1_Part1aE_Test1"), ]
pre_PS_tasks_2E_4 <- pre_test[ which(pre_test$task_part =="T1P2E" & pre_test$task_name=="PS_T1_Part1aE_Test4"), ]
pre_PS_tasks_2E_6 <- pre_test[ which(pre_test$task_part =="T1P2E" & pre_test$task_name=="PS_T1_Part1aE_Test6"), ]
pre_PS_tasks_2E_7 <- pre_test[ which(pre_test$task_part =="T1P2E" & pre_test$task_name=="PS_T1_Part1aE_Test7"), ]

pre_PS_tasks_2NE_2 <- pre_test[ which(pre_test$task_part =="T1P2NE" & pre_test$task_name=="PS_T1_Part1aNE_Test2"), ]
pre_PS_tasks_2NE_3 <- pre_test[ which(pre_test$task_part =="T1P2NE" & pre_test$task_name=="PS_T1_Part1aNE_Test3"), ]
pre_PS_tasks_2NE_5 <- pre_test[ which(pre_test$task_part =="T1P2NE" & pre_test$task_name=="PS_T1_Part1aNE_Test5"), ]
pre_PS_tasks_2NE_7 <- pre_test[ which(pre_test$task_part =="T1P2NE" & pre_test$task_name=="PS_T1_Part1aNE_Test7"), ]


# ordering by study log id 
pre_PS_tasks_1_1 <- pre_PS_tasks_1_1[order(pre_PS_tasks_1_1$study_log_id), ]
pre_PS_tasks_1_3 <- pre_PS_tasks_1_3[order(pre_PS_tasks_1_3$study_log_id), ]
pre_PS_tasks_1_5 <- pre_PS_tasks_1_5[order(pre_PS_tasks_1_5$study_log_id), ]
pre_PS_tasks_1_7 <- pre_PS_tasks_1_7[order(pre_PS_tasks_1_7$study_log_id), ]
pre_PS_tasks_1_8 <- pre_PS_tasks_1_8[order(pre_PS_tasks_1_8$study_log_id), ]
pre_PS_tasks_1_9 <- pre_PS_tasks_1_9[order(pre_PS_tasks_1_9$study_log_id), ]
pre_PS_tasks_1_13 <- pre_PS_tasks_1_13[order(pre_PS_tasks_1_13$study_log_id), ]
pre_PS_tasks_1_16 <- pre_PS_tasks_1_16[order(pre_PS_tasks_1_16$study_log_id), ]

pre_PS_tasks_2E_1 <- pre_PS_tasks_2E_1[order(pre_PS_tasks_2E_1$study_log_id), ]
pre_PS_tasks_2E_4 <- pre_PS_tasks_2E_4[order(pre_PS_tasks_2E_4$study_log_id), ]
pre_PS_tasks_2E_6 <- pre_PS_tasks_2E_6[order(pre_PS_tasks_2E_6$study_log_id), ]
pre_PS_tasks_2E_7 <- pre_PS_tasks_2E_7[order(pre_PS_tasks_2E_7$study_log_id), ]

pre_PS_tasks_2NE_2 <- pre_PS_tasks_2NE_2[order(pre_PS_tasks_2NE_2$study_log_id), ]
pre_PS_tasks_2NE_3 <- pre_PS_tasks_2NE_3[order(pre_PS_tasks_2NE_3$study_log_id), ]
pre_PS_tasks_2NE_5 <- pre_PS_tasks_2NE_5[order(pre_PS_tasks_2NE_5$study_log_id), ]
pre_PS_tasks_2NE_7 <- pre_PS_tasks_2NE_7[order(pre_PS_tasks_2NE_7$study_log_id), ]

# Keep the FIRST ATTEMPT ONLY (distinct function: If there are duplicate rows, only the first row is preserved)
pre_PS_tasks_1_1 <- pre_PS_tasks_1_1 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_3 <- pre_PS_tasks_1_3 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_5 <- pre_PS_tasks_1_5 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_7 <- pre_PS_tasks_1_7 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_8 <- pre_PS_tasks_1_8 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_9 <- pre_PS_tasks_1_9 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_13 <- pre_PS_tasks_1_13 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_1_16 <- pre_PS_tasks_1_16 %>% distinct(student_id, .keep_all = TRUE)

pre_PS_tasks_2E_1 <- pre_PS_tasks_2E_1 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2E_4 <- pre_PS_tasks_2E_4 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2E_6 <- pre_PS_tasks_2E_6 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2E_7 <- pre_PS_tasks_2E_7 %>% distinct(student_id, .keep_all = TRUE)

pre_PS_tasks_2NE_2 <- pre_PS_tasks_2NE_2 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2NE_3 <- pre_PS_tasks_2NE_3 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2NE_5 <- pre_PS_tasks_2NE_5 %>% distinct(student_id, .keep_all = TRUE)
pre_PS_tasks_2NE_7 <- pre_PS_tasks_2NE_7 %>% distinct(student_id, .keep_all = TRUE)


# merge the datasets 
pre_PS_tasks <- do.call("rbind", list(pre_PS_tasks_1_1, pre_PS_tasks_1_3, pre_PS_tasks_1_5, 
                pre_PS_tasks_1_7, pre_PS_tasks_1_8, pre_PS_tasks_1_9, pre_PS_tasks_1_13, 
                pre_PS_tasks_1_16, pre_PS_tasks_2E_1, pre_PS_tasks_2E_4, pre_PS_tasks_2E_6, 
                pre_PS_tasks_2E_7, pre_PS_tasks_2NE_2, pre_PS_tasks_2NE_3, pre_PS_tasks_2NE_5,
                pre_PS_tasks_2NE_7))


pre_PS_tasks$task_part_name <- paste(pre_PS_tasks$task_part, pre_PS_tasks$task_name)

```

# PRETEST- PS tasks score
```{r}
pre_PS_tasks_score <- dcast(pre_PS_tasks, 
                      student_id ~ task_part_name, 
                      value.var = "correctness", 
                      fun.aggregate = sum, na.rm = FALSE)


col_order_pre <- c("student_id", "T1P1 PS_Part1_Test1",	"T1P1 PS_Part1_Test3",	
                 "T1P1 PS_Part1_Test5",	"T1P1 PS_Part1_Test7",	
                 "T1P1 PS_Part1_Test8",	"T1P1 PS_Part1_Test9",	
                 "T1P1 PS_Part1_Test13",	"T1P1 PS_Part1_Test16",	
                 
                 "T1P2E PS_T1_Part1aE_Test1",	"T1P2E PS_T1_Part1aE_Test4",	
                 "T1P2E PS_T1_Part1aE_Test6",	"T1P2E PS_T1_Part1aE_Test7",	
                 
                 "T1P2NE PS_T1_Part1aNE_Test2", "T1P2NE PS_T1_Part1aNE_Test3",	
                 "T1P2NE PS_T1_Part1aNE_Test5", "T1P2NE PS_T1_Part1aNE_Test7")

pre_PS_tasks_score <- pre_PS_tasks_score[, col_order_pre]


pre_PS_tasks_score <- pre_PS_tasks_score %>%
  mutate(pre.PS_tasks_total_score = as.numeric(apply(pre_PS_tasks_score[,2:17], 1, sum)),
          
         pre.PS_part1_score = as.numeric(apply(pre_PS_tasks_score[,2:9], 1, sum)),
         
         pre.PS_part2E_score = as.numeric(apply(pre_PS_tasks_score[,10:13], 1, sum)),
         
         pre.PS_part2NE_score = as.numeric(apply(pre_PS_tasks_score[,14:17], 1, sum)))
```



# PRETEST- PS tasks time
```{r}
pre_PS_tasks_time <- dcast(pre_PS_tasks, 
                     student_id ~ task_part_name,
                     value.var = "response_time", 
                     na.rm = TRUE)

pre_PS_tasks_time <- pre_PS_tasks_time[, col_order_pre]


pre_PS_tasks_time <- pre_PS_tasks_time %>%
          rename("T1P1 PS_Part1_Test1_RT" = "T1P1 PS_Part1_Test1", 
         "T1P1 PS_Part1_Test3_RT" = "T1P1 PS_Part1_Test3",	
         "T1P1 PS_Part1_Test5_RT" = "T1P1 PS_Part1_Test5",	
         "T1P1 PS_Part1_Test7_RT" = "T1P1 PS_Part1_Test7",	
         "T1P1 PS_Part1_Test8_RT" = "T1P1 PS_Part1_Test8",	
         "T1P1 PS_Part1_Test9_RT" = "T1P1 PS_Part1_Test9",	
         "T1P1 PS_Part1_Test13_RT" = "T1P1 PS_Part1_Test13",	
         "T1P1 PS_Part1_Test16_RT" = "T1P1 PS_Part1_Test16",	
         
         "T1P2E PS_Part2a_Test1_RT" = "T1P2E PS_T1_Part1aE_Test1",	
         "T1P2E PS_Part2a_Test4_RT" = "T1P2E PS_T1_Part1aE_Test4",	
         "T1P2E PS_Part2a_Test6_RT" = "T1P2E PS_T1_Part1aE_Test6",	
         "T1P2E PS_Part2a_Test7_RT" = "T1P2E PS_T1_Part1aE_Test7",	
         
         "T1P2NE PS_Part2a_Test2_RT" = "T1P2NE PS_T1_Part1aNE_Test2", 
         "T1P2NE PS_Part2a_Test3_RT" = "T1P2NE PS_T1_Part1aNE_Test3",	
         "T1P2NE PS_Part2a_Test5_RT" = "T1P2NE PS_T1_Part1aNE_Test5", 
         "T1P2NE PS_Part2a_Test7_RT" = "T1P2NE PS_T1_Part1aNE_Test7")

# Replacing negative values by zero 

pre_PS_tasks_time[pre_PS_tasks_time < 0] <- 0 


# calculating the time variables 

pre_PS_tasks_time <- pre_PS_tasks_time %>%
  mutate(pre.PS_completed_num = rowSums(pre_PS_tasks_time[,2:17] !="", na.rm=TRUE),
         
         pre.PS_completed_percent = pre.PS_completed_num/16*100,
         
         pre.PS_total_RT_sec = as.numeric(apply(pre_PS_tasks_time[,2:17], 1, sum, na.rm=TRUE)),
         
         pre.PS_total_RT_min = pre.PS_total_RT_sec/60,
         
         pre.PS_avg_RT_sec = pre.PS_total_RT_sec/pre.PS_completed_num,
         
         pre.PS_part1_RT_sec = as.numeric(apply(pre_PS_tasks_time[,2:9], 1, sum)),
         
         pre.PS_part2E_RT_sec = as.numeric(apply(pre_PS_tasks_time[,10:13], 1, sum)),
         
         pre.PS_part2NE_RT_sec = as.numeric(apply(pre_PS_tasks_time[,14:17], 1, sum)))

```



###### Reshaping the mid-assessment data #######

### subsetting
```{r}
mid_math <- mid_test[ which(mid_test$problem_num %in% 
                              c("06_02_P", "06_03_F", "06_04_C", 
                                "06_06_F", "06_07_P", "06_08_C", 
                                "06_09_C", "06_11_P", 
                                "06_12_F", "06_13_C")), ]
```

### MIDTEST- correctness (item level)
```{r}
mid_math_score <- dcast(mid_math, 
                        student_id ~ problem_num, 
                        value.var = "correct", 
                        fun.aggregate = sum, na.rm = FALSE)

setnames(mid_math_score, old=c("06_02_P", "06_03_F", "06_04_C", 
                               "06_06_F", "06_07_P", "06_08_C", 
                               "06_09_C", "06_11_P", 
                               "06_12_F", "06_13_C"), 
         
         new=c("correct.06_02_P", "correct.06_03_F", "correct.06_04_C", 
               "correct.06_06_F", "correct.06_07_P", "correct.06_08_C", 
               "correct.06_09_C", "correct.06_11_P", 
               "correct.06_12_F", "correct.06_13_C"), 
         skip_absent=TRUE)
```


### midTEST- math performance 
```{r}
mid_math_score <- mid_math_score %>%
  mutate(mid.total_math_score = (correct.06_02_P + correct.06_03_F + 
                                   correct.06_04_C + correct.06_06_F + 
                                   correct.06_07_P + correct.06_08_C + 
                                   correct.06_09_C + correct.06_11_P +
                                   correct.06_12_F + correct.06_13_C),
         
         mid.percentage_math_score = (mid.total_math_score/10)*100,
         
         mid.sub_P_score = (correct.06_02_P + correct.06_07_P + correct.06_11_P),
         
         mid.sub_C_score = (correct.06_04_C + correct.06_08_C +
                              correct.06_09_C + correct.06_13_C),
         
         mid.sub_F_score = (correct.06_03_F + correct.06_06_F + correct.06_12_F)) 
```

# midTEST- Completion &  Time taken
```{r}
mid_time <- dcast(mid_test, 
                  student_id ~ problem_num, 
                  value.var = "estimated_time_on_task", 
                  fun.aggregate = sum, na.rm = FALSE)

mid_time[mid_time == 0] <- NA

mid_time <- mid_time %>% select("student_id", "06_02_P", "06_03_F", "06_04_C", 
                                "06_06_F", "06_07_P", "06_08_C", 
                                "06_09_C", "06_11_P", 
                                "06_12_F", "06_13_C")

setnames(mid_time, old=c("06_02_P", "06_03_F", "06_04_C", 
                         "06_06_F", "06_07_P", "06_08_C", 
                         "06_09_C", "06_11_P", 
                         "06_12_F", "06_13_C"), 
         
         new=c("time_on_task.06_02_P", "time_on_task.06_03_F", "time_on_task.06_04_C", 
               "time_on_task.06_06_F", "time_on_task.06_07_P", "time_on_task.06_08_C", 
               "time_on_task.06_09_C", "time_on_task.06_11_P", 
               "time_on_task.06_12_F", "time_on_task.06_13_C"), skip_absent=TRUE)

mid_time <- mid_time %>%
  mutate(mid.math_completed_num = rowSums(mid_time[,2:11] !="", na.rm=TRUE),
         
         mid.math_completed_percent = mid.math_completed_num/10*100,
         
         mid.total_time_on_tasks = as.numeric(apply(mid_time[,2:11], 1, sum, na.rm=TRUE)),
         
         mid.avg_time_on_tasks = mid.total_time_on_tasks/mid.math_completed_num)

```


# midTEST- math anxiety (item level)
```{r}
# subsetting MA score 
mid_MA <- mid_test[ which(mid_test$problem_id.x=="PRABKM8Y"), ]

mid_MA_06 <- mid_MA[ which(mid_MA$problem_num %in%
                             c('MA_15_NR','MA_16_NR', 'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W')), ]

mid_MA_02 <- mid_MA[ which(mid_MA$problem_num %in% c('MA_17_NC', 'MA_18_NC', 'MA_19_NC')), ]

# re-coding 
mid_MA_06$answer_text[mid_MA_06$answer_text=="No"] <- "0"
mid_MA_06$answer_text[mid_MA_06$answer_text=="Not really"] <- "1"
mid_MA_06$answer_text[mid_MA_06$answer_text=="Kind of"] <- "2"
mid_MA_06$answer_text[mid_MA_06$answer_text=="Yes"] <- "3"

mid_MA_06$answer_text <- as.numeric(as.character(mid_MA_06$answer_text))

# re-coding (reverse scoring)
mid_MA_02$answer_text[mid_MA_02$answer_text=="No"] <- "3"
mid_MA_02$answer_text[mid_MA_02$answer_text=="Not really"] <- "2"
mid_MA_02$answer_text[mid_MA_02$answer_text=="Kind of"] <- "1"
mid_MA_02$answer_text[mid_MA_02$answer_text=="Yes"] <- "0"

mid_MA_02$answer_text <- as.numeric(as.character(mid_MA_02$answer_text))

mid_MA_merge <- rbind(mid_MA_06, mid_MA_02)
```

# midTEST- math anxiety scores 
```{r}
# wide to long 

mid_MA_score <- dcast(mid_MA_merge, 
                      student_id ~ problem_num, 
                      value.var = "answer_text", 
                      fun.aggregate = sum, na.rm = FALSE)

setnames(mid_MA_score, old=c('MA_15_NR','MA_16_NR', 'MA_17_NC', 'MA_18_NC', 'MA_19_NC',
                             'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W'), 
         
         new=c('mi_MA_15_NR','mi_MA_16_NR', 'mi_MA_17_NC', 'mi_MA_18_NC', 'mi_MA_19_NC',
               'mi_MA_20_W', 'mi_MA_21_W', 'mi_MA_22_NR', 'mi_MA_23_W'),
         
         skip_absent=TRUE)


# calculation 
mid_MA_score <- mid_MA_score %>%
  mutate(mid.MA_total_score = as.numeric(apply(mid_MA_score[,2:10], 1, sum)),
         
         mid.MA_avg_score = mid.MA_total_score/9,
         
         mid.negative_reaction_score = mi_MA_15_NR + mi_MA_16_NR + mi_MA_22_NR,
         
         mid.numerical_confindence_score = mi_MA_17_NC + mi_MA_18_NC + mi_MA_19_NC,
         
         mid.worry_score = mi_MA_20_W + mi_MA_21_W + mi_MA_23_W)
```



# midTEST- PS tasks 
```{r}
### subsetting PS tasks 
mid_PS_tasks_1_2 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test2"), ]
mid_PS_tasks_1_4 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test4"), ]
mid_PS_tasks_1_6 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test6"), ]
mid_PS_tasks_1_10 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test10"), ]
mid_PS_tasks_1_11 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test11"), ]
mid_PS_tasks_1_12 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test12"), ]
mid_PS_tasks_1_14 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test14"), ]
mid_PS_tasks_1_15 <- mid_test[ which(mid_test$task_name=="PS_Part1_Test15"), ]


mid_PS_tasks_2E_3 <- mid_test[ which(mid_test$task_part =="T2P2E" & mid_test$task_name=="PS_T2_Part2aE_Test3"), ]
mid_PS_tasks_2E_2 <- mid_test[ which(mid_test$task_part =="T2P2E" & mid_test$task_name=="PS_T2_Part2aE_Test2"), ]
mid_PS_tasks_2E_5 <- mid_test[ which(mid_test$task_part =="T2P2E" & mid_test$task_name=="PS_T2_Part2aE_Test5"), ]
mid_PS_tasks_2E_8 <- mid_test[ which(mid_test$task_part =="T2P2E" & mid_test$task_name=="PS_T2_Part2aE_Test8"), ]

mid_PS_tasks_2NE_1 <- mid_test[ which(mid_test$task_part =="T2P2NE" & mid_test$task_name=="PS_T2_Part2aNE_Test1"), ]
mid_PS_tasks_2NE_6 <- mid_test[ which(mid_test$task_part =="T2P2NE" & mid_test$task_name=="PS_T2_Part2aNE_Test6"), ]
mid_PS_tasks_2NE_4 <- mid_test[ which(mid_test$task_part =="T2P2NE" & mid_test$task_name=="PS_T2_Part2aNE_Test4"), ]
mid_PS_tasks_2NE_8 <- mid_test[ which(mid_test$task_part =="T2P2NE" & mid_test$task_name=="PS_T2_Part2aNE_Test8"), ]


# ordering by study log id 
mid_PS_tasks_1_2 <- mid_PS_tasks_1_2[order(mid_PS_tasks_1_2$study_log_id), ]
mid_PS_tasks_1_4 <- mid_PS_tasks_1_4[order(mid_PS_tasks_1_4$study_log_id), ]
mid_PS_tasks_1_6 <- mid_PS_tasks_1_6[order(mid_PS_tasks_1_6$study_log_id), ]
mid_PS_tasks_1_10 <- mid_PS_tasks_1_10[order(mid_PS_tasks_1_10$study_log_id), ]
mid_PS_tasks_1_11 <- mid_PS_tasks_1_11[order(mid_PS_tasks_1_11$study_log_id), ]
mid_PS_tasks_1_12 <- mid_PS_tasks_1_12[order(mid_PS_tasks_1_12$study_log_id), ]
mid_PS_tasks_1_14 <- mid_PS_tasks_1_14[order(mid_PS_tasks_1_14$study_log_id), ]
mid_PS_tasks_1_15 <- mid_PS_tasks_1_15[order(mid_PS_tasks_1_15$study_log_id), ]

mid_PS_tasks_2E_2 <- mid_PS_tasks_2E_2[order(mid_PS_tasks_2E_2$study_log_id), ]
mid_PS_tasks_2E_3 <- mid_PS_tasks_2E_3[order(mid_PS_tasks_2E_3$study_log_id), ]
mid_PS_tasks_2E_5 <- mid_PS_tasks_2E_5[order(mid_PS_tasks_2E_5$study_log_id), ]
mid_PS_tasks_2E_8 <- mid_PS_tasks_2E_8[order(mid_PS_tasks_2E_8$study_log_id), ]

mid_PS_tasks_2NE_1 <- mid_PS_tasks_2NE_1[order(mid_PS_tasks_2NE_1$study_log_id), ]
mid_PS_tasks_2NE_4 <- mid_PS_tasks_2NE_4[order(mid_PS_tasks_2NE_4$study_log_id), ]
mid_PS_tasks_2NE_6 <- mid_PS_tasks_2NE_6[order(mid_PS_tasks_2NE_6$study_log_id), ]
mid_PS_tasks_2NE_8 <- mid_PS_tasks_2NE_8[order(mid_PS_tasks_2NE_8$study_log_id), ]

# Keep the FIRST ATTEMPT ONLY (distinct function: If there are duplicate rows, only the first row is midserved)
mid_PS_tasks_1_2 <- mid_PS_tasks_1_2 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_4 <- mid_PS_tasks_1_4 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_6 <- mid_PS_tasks_1_6 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_10 <- mid_PS_tasks_1_10 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_11 <- mid_PS_tasks_1_11 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_12 <- mid_PS_tasks_1_12 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_14 <- mid_PS_tasks_1_14 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_1_15 <- mid_PS_tasks_1_15 %>% distinct(student_id, .keep_all = TRUE)

mid_PS_tasks_2E_2 <- mid_PS_tasks_2E_2 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2E_3 <- mid_PS_tasks_2E_3 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2E_5 <- mid_PS_tasks_2E_5 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2E_8 <- mid_PS_tasks_2E_8 %>% distinct(student_id, .keep_all = TRUE)

mid_PS_tasks_2NE_1 <- mid_PS_tasks_2NE_1 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2NE_4 <- mid_PS_tasks_2NE_4 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2NE_6 <- mid_PS_tasks_2NE_6 %>% distinct(student_id, .keep_all = TRUE)
mid_PS_tasks_2NE_8 <- mid_PS_tasks_2NE_8 %>% distinct(student_id, .keep_all = TRUE)


# merge the datasets 
mid_PS_tasks <- do.call("rbind", list(mid_PS_tasks_1_2, mid_PS_tasks_1_4, mid_PS_tasks_1_6, 
                                      mid_PS_tasks_1_10, mid_PS_tasks_1_11, mid_PS_tasks_1_12, 
                                      mid_PS_tasks_1_14, mid_PS_tasks_1_15, 
                                      mid_PS_tasks_2E_2, mid_PS_tasks_2E_3, mid_PS_tasks_2E_5, mid_PS_tasks_2E_8, 
                                      mid_PS_tasks_2NE_1, mid_PS_tasks_2NE_4, mid_PS_tasks_2NE_6, mid_PS_tasks_2NE_8))


mid_PS_tasks$task_part_name <- paste(mid_PS_tasks$task_part, mid_PS_tasks$task_name)

```

# midTEST- PS tasks score
```{r}
mid_PS_tasks_score <- dcast(mid_PS_tasks, 
                            student_id ~ task_part_name, 
                            value.var = "correctness", 
                            fun.aggregate = sum, na.rm = FALSE)


col_order_mid <- c("student_id", "T2P1 PS_Part1_Test2",	"T2P1 PS_Part1_Test4",	
                 "T2P1 PS_Part1_Test6",	"T2P1 PS_Part1_Test10",	
                 "T2P1 PS_Part1_Test11",	"T2P1 PS_Part1_Test12",	
                 "T2P1 PS_Part1_Test14",	"T2P1 PS_Part1_Test15",	
                 
                 "T2P2E PS_T2_Part2aE_Test2",	"T2P2E PS_T2_Part2aE_Test3",	
                 "T2P2E PS_T2_Part2aE_Test5",	"T2P2E PS_T2_Part2aE_Test8",	
                 
                 "T2P2NE PS_T2_Part2aNE_Test1", "T2P2NE PS_T2_Part2aNE_Test4",	
                 "T2P2NE PS_T2_Part2aNE_Test6", "T2P2NE PS_T2_Part2aNE_Test8")

mid_PS_tasks_score <- mid_PS_tasks_score[, col_order_mid]


mid_PS_tasks_score <- mid_PS_tasks_score %>%
  mutate(mid.PS_tasks_total_score = as.numeric(apply(mid_PS_tasks_score[,2:17], 1, sum)),
         
         mid.PS_part1_score = as.numeric(apply(mid_PS_tasks_score[,2:9], 1, sum)),
         
         mid.PS_part2E_score = as.numeric(apply(mid_PS_tasks_score[,10:13], 1, sum)),
         
         mid.PS_part2NE_score = as.numeric(apply(mid_PS_tasks_score[,14:17], 1, sum)))

```



# midTEST- PS tasks time
```{r}
mid_PS_tasks_time <- dcast(mid_PS_tasks, 
                           student_id ~ task_part_name,
                           value.var = "response_time", 
                           na.rm = TRUE)


mid_PS_tasks_time <- mid_PS_tasks_time[, col_order_mid]


mid_PS_tasks_time <- mid_PS_tasks_time %>%
  rename("T2P1 PS_Part1_Test2_RT" = "T2P1 PS_Part1_Test2", 
         "T2P1 PS_Part1_Test4_RT" = "T2P1 PS_Part1_Test4",	
         "T2P1 PS_Part1_Test6_RT" = "T2P1 PS_Part1_Test6",	
         "T2P1 PS_Part1_Test10_RT" = "T2P1 PS_Part1_Test10",	
         "T2P1 PS_Part1_Test11_RT" = "T2P1 PS_Part1_Test11",	
         "T2P1 PS_Part1_Test12_RT" = "T2P1 PS_Part1_Test12",	
         "T2P1 PS_Part1_Test14_RT" = "T2P1 PS_Part1_Test14",	
         "T2P1 PS_Part1_Test15_RT" = "T2P1 PS_Part1_Test15",	
         
         "T2P2E PS_T2_Part2aE_Test2_RT" = "T2P2E PS_T2_Part2aE_Test2",	
         "T2P2E PS_T2_Part2aE_Test3_RT" = "T2P2E PS_T2_Part2aE_Test3",	
         "T2P2E PS_T2_Part2aE_Test5_RT" = "T2P2E PS_T2_Part2aE_Test5",	
         "T2P2E PS_T2_Part2aE_Test8_RT" = "T2P2E PS_T2_Part2aE_Test8",	
         
         "T2P2NE PS_T2_Part2aNE_Test1_RT" = "T2P2NE PS_T2_Part2aNE_Test1", 
         "T2P2NE PS_T2_Part2aNE_Test4_RT" = "T2P2NE PS_T2_Part2aNE_Test4",	
         "T2P2NE PS_T2_Part2aNE_Test6_RT" = "T2P2NE PS_T2_Part2aNE_Test6", 
         "T2P2NE PS_T2_Part2aNE_Test8_RT" = "T2P2NE PS_T2_Part2aNE_Test8")

# Replacing negative values by zero 

mid_PS_tasks_time[mid_PS_tasks_time < 0] <- 0 


# calculating the time variables 

mid_PS_tasks_time <- mid_PS_tasks_time %>%
  mutate(mid.PS_completed_num = rowSums(mid_PS_tasks_time[,2:17] !="", na.rm=TRUE),
         
         mid.PS_completed_percent = mid.PS_completed_num/16*100,
         
         mid.PS_total_RT_sec = as.numeric(apply(mid_PS_tasks_time[,2:17], 1, sum, na.rm=TRUE)),
         
         mid.PS_total_RT_min = mid.PS_total_RT_sec/60,
         
         mid.PS_avg_RT_sec = mid.PS_total_RT_sec/mid.PS_completed_num,
         
         mid.PS_part1_RT_sec = as.numeric(apply(mid_PS_tasks_time[,2:9], 1, sum)),
         
         mid.PS_part2E_RT_sec = as.numeric(apply(mid_PS_tasks_time[,10:13], 1, sum)),
         
         mid.PS_part2NE_RT_sec = as.numeric(apply(mid_PS_tasks_time[,14:17], 1, sum)))

```





###### Reshaping the post-assessment data #######

### subsetting
```{r}
post_math <- post_test[ which(post_test$problem_num %in% 
                              c("12_02_P", "12_03_F", "12_04_C", 
                                "12_06_F", "12_07_P", 
                                "12_08_C", "12_09_C", "12_11_P", 
                                "12_12_F", "12_13_C")), ]
```

### postTEST- correctness (item level)
```{r}
post_math_score <- dcast(post_math, 
                        student_id ~ problem_num, 
                        value.var = "correct", 
                        fun.aggregate = sum, na.rm = FALSE)

setnames(post_math_score, old=c("12_02_P", "12_03_F", "12_04_C", 
                                "12_06_F", "12_07_P", 
                                "12_08_C", "12_09_C", "12_11_P", 
                                "12_12_F", "12_13_C"), 
         
         new=c("correct.12_02_P", "correct.12_03_F", "correct.12_04_C", 
               "correct.12_06_F", "correct.12_07_P", 
               "correct.12_08_C", "correct.12_09_C", "correct.12_11_P", 
               "correct.12_12_F", "correct.12_13_C"), 
         skip_absent=TRUE)
```


### postTEST- math performance 
```{r}
post_math_score <- post_math_score %>%
  mutate(post.total_math_score = (correct.12_02_P + correct.12_03_F + 
                                   correct.12_04_C + correct.12_06_F + 
                                   correct.12_07_P + correct.12_08_C + 
                                   correct.12_09_C + correct.12_11_P +
                                   correct.12_12_F + correct.12_13_C),
         
         post.percentage_math_score = (post.total_math_score/10)*100,
         
         post.sub_P_score = (correct.12_02_P + correct.12_07_P + correct.12_11_P),
         
         post.sub_C_score = (correct.12_04_C + correct.12_08_C +
                              correct.12_09_C + correct.12_13_C),
         
         post.sub_F_score = (correct.12_03_F + correct.12_06_F + correct.12_12_F)) 
```

# postTEST- Completion &  Time taken
```{r}
post_time <- dcast(post_test, 
                  student_id ~ problem_num, 
                  value.var = "estimated_time_on_task", 
                  fun.aggregate = sum, na.rm = FALSE)

post_time[post_time == 0] <- NA

post_time <- post_time %>% select("student_id", "12_02_P", "12_03_F", "12_04_C", 
                                "12_06_F", "12_07_P", 
                                "12_08_C", "12_09_C", "12_11_P", 
                                "12_12_F", "12_13_C")

setnames(post_time, old=c("12_02_P", "12_03_F", "12_04_C", 
                                "12_06_F", "12_07_P", 
                                "12_08_C", "12_09_C", "12_11_P", 
                                "12_12_F", "12_13_C"), 
         
         new=c("time_on_task.12_02_P", "time_on_task.12_03_F", "time_on_task.12_04_C", 
               "time_on_task.12_06_F", "time_on_task.12_07_P", "time_on_task.12_08_C", 
               "time_on_task.12_09_C", "time_on_task.12_11_P", 
               "time_on_task.12_12_F", "time_on_task.12_13_C"), skip_absent=TRUE)

post_time <- post_time %>%
  mutate(post.math_completed_num = rowSums(post_time[,2:11] !="", na.rm=TRUE),
         
         post.math_completed_percent = post.math_completed_num/10*100,
         
         post.total_time_on_tasks = as.numeric(apply(post_time[,2:11], 1, sum, na.rm=TRUE)),
         
         post.avg_time_on_tasks = post.total_time_on_tasks/post.math_completed_num)

```


# postTEST- math anxiety (item level)
```{r}
# subsetting MA score 
post_MA <- post_test[ which(post_test$problem_id.x=="PRABKM8Y"), ]

post_MA_06 <- post_MA[ which(post_MA$problem_num %in%
                             c('MA_15_NR','MA_16_NR', 'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W')), ]

post_MA_02 <- post_MA[ which(post_MA$problem_num %in% c('MA_17_NC', 'MA_18_NC', 'MA_19_NC')), ]

# re-coding 
post_MA_06$answer_text[post_MA_06$answer_text=="No"] <- "0"
post_MA_06$answer_text[post_MA_06$answer_text=="Not really"] <- "1"
post_MA_06$answer_text[post_MA_06$answer_text=="Kind of"] <- "2"
post_MA_06$answer_text[post_MA_06$answer_text=="Yes"] <- "3"

post_MA_06$answer_text <- as.numeric(as.character(post_MA_06$answer_text))

# re-coding (reverse scoring)
post_MA_02$answer_text[post_MA_02$answer_text=="No"] <- "3"
post_MA_02$answer_text[post_MA_02$answer_text=="Not really"] <- "2"
post_MA_02$answer_text[post_MA_02$answer_text=="Kind of"] <- "1"
post_MA_02$answer_text[post_MA_02$answer_text=="Yes"] <- "0"

post_MA_02$answer_text <- as.numeric(as.character(post_MA_02$answer_text))

post_MA_merge <- rbind(post_MA_06, post_MA_02)
```

# postTEST- math anxiety scores 
```{r}
# wide to long 

post_MA_score <- dcast(post_MA_merge, 
                      student_id ~ problem_num, 
                      value.var = "answer_text", 
                      fun.aggregate = sum, na.rm = FALSE)

setnames(post_MA_score, old=c('MA_15_NR','MA_16_NR', 'MA_17_NC', 'MA_18_NC', 'MA_19_NC',
                             'MA_20_W', 'MA_21_W', 'MA_22_NR', 'MA_23_W'), 
         
         new=c('po_MA_15_NR','po_MA_16_NR', 'po_MA_17_NC', 'po_MA_18_NC', 'po_MA_19_NC',
               'po_MA_20_W', 'po_MA_21_W', 'po_MA_22_NR', 'po_MA_23_W'),
         
         skip_absent=TRUE)


# calculation 
post_MA_score <- post_MA_score %>%
  mutate(post.MA_total_score = as.numeric(apply(post_MA_score[,2:10], 1, sum)),
         
         post.MA_avg_score = post.MA_total_score/9,
         
         post.negative_reaction_score = po_MA_15_NR + po_MA_16_NR + po_MA_22_NR,
         
         post.numerical_confindence_score = po_MA_17_NC + po_MA_18_NC + po_MA_19_NC,
         
         post.worry_score = po_MA_20_W + po_MA_21_W + po_MA_23_W)
```



# postTEST- math self-efficacy (item level)
```{r}
# subsetting MSE score 
post_MSE <- post_test[ which(post_test$problem_id.x=="PRABKM8Z"), ]

# recoding 
post_MSE$answer_text[post_MSE$answer_text=="Never"] <- "0"
post_MSE$answer_text[post_MSE$answer_text=="Very rarely"] <- "1"
post_MSE$answer_text[post_MSE$answer_text=="Rarely"] <- "2"
post_MSE$answer_text[post_MSE$answer_text=="Often"] <- "3"
post_MSE$answer_text[post_MSE$answer_text=="Very often"] <- "4"
post_MSE$answer_text[post_MSE$answer_text=="Very Often"] <- "4"
post_MSE$answer_text[post_MSE$answer_text=="Always"] <- "5"

post_MSE$answer_text <- as.numeric(as.character(post_MSE$answer_text))
```

# postTEST- math self-efficacy scores 
```{r}
# wide to long 
post_MSE_score <- dcast(post_MSE, 
                       student_id ~ problem_num, 
                       value.var = "answer_text", 
                       fun.aggregate = sum, na.rm = FALSE)

setnames(post_MSE_score, old=c("MSE_24", "MSE_25", "MSE_26", "MSE_27", "MSE_28"), 
         
         new=c("po_MSE_24",	"po_MSE_25",	"po_MSE_26",	"po_MSE_27",	
               "po_MSE_28"),
         
         skip_absent=TRUE)


post_MSE_score <- post_MSE_score %>%
          mutate(post.MSE_total_score = po_MSE_24 + po_MSE_25 + po_MSE_26 + 
                                       po_MSE_27 + po_MSE_28, 
                   
                 post.MSE_avg_score = post.MSE_total_score/5)

```



# postTEST- PS tasks 
```{r}
### subsetting PS tasks 
post_PS_tasks_1_7 <- post_test[ which(post_test$task_name=="PS_Part1_Test7"), ]
post_PS_tasks_1_1 <- post_test[ which(post_test$task_name=="PS_Part1_Test1"), ]
post_PS_tasks_1_3 <- post_test[ which(post_test$task_name=="PS_Part1_Test3"), ]
post_PS_tasks_1_5 <- post_test[ which(post_test$task_name=="PS_Part1_Test5"), ]
post_PS_tasks_1_13 <- post_test[ which(post_test$task_name=="PS_Part1_Test13"), ]
post_PS_tasks_1_16 <- post_test[ which(post_test$task_name=="PS_Part1_Test16"), ]
post_PS_tasks_1_9 <- post_test[ which(post_test$task_name=="PS_Part1_Test9"), ]
post_PS_tasks_1_8 <- post_test[ which(post_test$task_name=="PS_Part1_Test8"), ]

post_PS_tasks_2E_4 <- post_test[ which(post_test$task_part =="T3P2E" & post_test$task_name=="PS_T3_Part1bE_Test4"), ]
post_PS_tasks_2E_6 <- post_test[ which(post_test$task_part =="T3P2E" & post_test$task_name=="PS_T3_Part1bE_Test6"), ]
post_PS_tasks_2E_1 <- post_test[ which(post_test$task_part =="T3P2E" & post_test$task_name=="PS_T3_Part1bE_Test1"), ]
post_PS_tasks_2E_7 <- post_test[ which(post_test$task_part =="T3P2E" & post_test$task_name=="PS_T3_Part1bE_Test7"), ]

post_PS_tasks_2NE_7 <- post_test[ which(post_test$task_part =="T3P2NE" & post_test$task_name=="PS_T3_Part1bNE_Test7"), ]
post_PS_tasks_2NE_3 <- post_test[ which(post_test$task_part =="T3P2NE" & post_test$task_name=="PS_T3_Part1bNE_Test3"), ]
post_PS_tasks_2NE_2 <- post_test[ which(post_test$task_part =="T3P2NE" & post_test$task_name=="PS_T3_Part1bNE_Test2"), ]
post_PS_tasks_2NE_5 <- post_test[ which(post_test$task_part =="T3P2NE" & post_test$task_name=="PS_T3_Part1bNE_Test5"), ]


# ordering by study log id 
post_PS_tasks_1_7 <- post_PS_tasks_1_7[order(post_PS_tasks_1_7$study_log_id), ]
post_PS_tasks_1_1 <- post_PS_tasks_1_1[order(post_PS_tasks_1_1$study_log_id), ]
post_PS_tasks_1_3 <- post_PS_tasks_1_3[order(post_PS_tasks_1_3$study_log_id), ]
post_PS_tasks_1_5 <- post_PS_tasks_1_5[order(post_PS_tasks_1_5$study_log_id), ]
post_PS_tasks_1_13 <- post_PS_tasks_1_13[order(post_PS_tasks_1_13$study_log_id), ]
post_PS_tasks_1_16 <- post_PS_tasks_1_16[order(post_PS_tasks_1_16$study_log_id), ]
post_PS_tasks_1_9 <- post_PS_tasks_1_9[order(post_PS_tasks_1_9$study_log_id), ]
post_PS_tasks_1_8 <- post_PS_tasks_1_8[order(post_PS_tasks_1_8$study_log_id), ]

post_PS_tasks_2E_4 <- post_PS_tasks_2E_4[order(post_PS_tasks_2E_4$study_log_id), ]
post_PS_tasks_2E_6 <- post_PS_tasks_2E_6[order(post_PS_tasks_2E_6$study_log_id), ]
post_PS_tasks_2E_1 <- post_PS_tasks_2E_1[order(post_PS_tasks_2E_1$study_log_id), ]
post_PS_tasks_2E_7 <- post_PS_tasks_2E_7[order(post_PS_tasks_2E_7$study_log_id), ]

post_PS_tasks_2NE_7 <- post_PS_tasks_2NE_7[order(post_PS_tasks_2NE_7$study_log_id), ]
post_PS_tasks_2NE_3 <- post_PS_tasks_2NE_3[order(post_PS_tasks_2NE_3$study_log_id), ]
post_PS_tasks_2NE_2 <- post_PS_tasks_2NE_2[order(post_PS_tasks_2NE_2$study_log_id), ]
post_PS_tasks_2NE_5 <- post_PS_tasks_2NE_5[order(post_PS_tasks_2NE_5$study_log_id), ]

# Keep the FIRST ATTEMPT ONLY (distinct function: If there are duplicate rows, only the first row is preserved)
post_PS_tasks_1_7 <- post_PS_tasks_1_7 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_1 <- post_PS_tasks_1_1 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_3 <- post_PS_tasks_1_3 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_5 <- post_PS_tasks_1_5 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_13 <- post_PS_tasks_1_13 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_16 <- post_PS_tasks_1_16 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_9 <- post_PS_tasks_1_9 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_1_8 <- post_PS_tasks_1_8 %>% distinct(student_id, .keep_all = TRUE)

post_PS_tasks_2E_4 <- post_PS_tasks_2E_4 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2E_6 <- post_PS_tasks_2E_6 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2E_1 <- post_PS_tasks_2E_1 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2E_7 <- post_PS_tasks_2E_7 %>% distinct(student_id, .keep_all = TRUE)

post_PS_tasks_2NE_7 <- post_PS_tasks_2NE_7 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2NE_3 <- post_PS_tasks_2NE_3 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2NE_2 <- post_PS_tasks_2NE_2 %>% distinct(student_id, .keep_all = TRUE)
post_PS_tasks_2NE_5 <- post_PS_tasks_2NE_5 %>% distinct(student_id, .keep_all = TRUE)


# merge the datasets 
post_PS_tasks <- do.call("rbind", list(post_PS_tasks_1_1, post_PS_tasks_1_3, post_PS_tasks_1_5, 
                                      post_PS_tasks_1_7, post_PS_tasks_1_8, post_PS_tasks_1_9, 
                                      post_PS_tasks_1_13, post_PS_tasks_1_16, 
                                      post_PS_tasks_2E_1, post_PS_tasks_2E_4, post_PS_tasks_2E_6, post_PS_tasks_2E_7, 
                                      post_PS_tasks_2NE_2, post_PS_tasks_2NE_3, post_PS_tasks_2NE_5, post_PS_tasks_2NE_7))


post_PS_tasks$task_part_name <- paste(post_PS_tasks$task_part, post_PS_tasks$task_name)

```

# postTEST- PS tasks score
```{r}
post_PS_tasks_score <- dcast(post_PS_tasks, 
                            student_id ~ task_part_name, 
                            value.var = "correctness", 
                            fun.aggregate = sum, na.rm = FALSE)


col_order_post <- c("student_id", "T3P1 PS_Part1_Test1",	"T3P1 PS_Part1_Test3",	
                 "T3P1 PS_Part1_Test5",	"T3P1 PS_Part1_Test7",	
                 "T3P1 PS_Part1_Test8",	"T3P1 PS_Part1_Test9",	
                 "T3P1 PS_Part1_Test13",	"T3P1 PS_Part1_Test16",	
                 
                 "T3P2E PS_T3_Part1bE_Test1",	"T3P2E PS_T3_Part1bE_Test4",	
                 "T3P2E PS_T3_Part1bE_Test6",	"T3P2E PS_T3_Part1bE_Test7",	
                 
                 "T3P2NE PS_T3_Part1bNE_Test2", "T3P2NE PS_T3_Part1bNE_Test3",	
                 "T3P2NE PS_T3_Part1bNE_Test5", "T3P2NE PS_T3_Part1bNE_Test7")

post_PS_tasks_score <- post_PS_tasks_score[, col_order_post]


post_PS_tasks_score <- post_PS_tasks_score %>%
  mutate(post.PS_tasks_total_score = as.numeric(apply(post_PS_tasks_score[,2:17], 1, sum)),
         
         post.PS_part1_score = as.numeric(apply(post_PS_tasks_score[,2:9], 1, sum)),
         
         post.PS_part2E_score = as.numeric(apply(post_PS_tasks_score[,10:13], 1, sum)),
         
         post.PS_part2NE_score = as.numeric(apply(post_PS_tasks_score[,14:17], 1, sum)))

```



# postTEST- PS tasks time
```{r}
post_PS_tasks_time <- dcast(post_PS_tasks, 
                           student_id ~ task_part_name,
                           value.var = "response_time", 
                           na.rm = TRUE)


post_PS_tasks_time <- post_PS_tasks_time[, col_order_post]


post_PS_tasks_time <- post_PS_tasks_time %>%
  rename("T3P1 PS_Part1_Test1_RT" = "T3P1 PS_Part1_Test1", 
         "T3P1 PS_Part1_Test3_RT" = "T3P1 PS_Part1_Test3",	
         "T3P1 PS_Part1_Test5_RT" = "T3P1 PS_Part1_Test5",	
         "T3P1 PS_Part1_Test7_RT" = "T3P1 PS_Part1_Test7",	
         "T3P1 PS_Part1_Test8_RT" = "T3P1 PS_Part1_Test8",	
         "T3P1 PS_Part1_Test9_RT" = "T3P1 PS_Part1_Test9",	
         "T3P1 PS_Part1_Test13_RT" = "T3P1 PS_Part1_Test13",	
         "T3P1 PS_Part1_Test16_RT" = "T3P1 PS_Part1_Test16",	
         
         "T3P2E PS_T3_Part1bE_Test1_RT" = "T3P2E PS_T3_Part1bE_Test1",	
         "T3P2E PS_T3_Part1bE_Test4_RT" = "T3P2E PS_T3_Part1bE_Test4",	
         "T3P2E PS_T3_Part1bE_Test6_RT" = "T3P2E PS_T3_Part1bE_Test6",	
         "T3P2E PS_T3_Part1bE_Test7_RT" = "T3P2E PS_T3_Part1bE_Test7",	
         
         "T3P2NE PS_T3_Part1bNE_Test2_RT" = "T3P2NE PS_T3_Part1bNE_Test2", 
         "T3P2NE PS_T3_Part1bNE_Test3_RT" = "T3P2NE PS_T3_Part1bNE_Test3",	
         "T3P2NE PS_T3_Part1bNE_Test5_RT" = "T3P2NE PS_T3_Part1bNE_Test5", 
         "T3P2NE PS_T3_Part1bNE_Test7_RT" = "T3P2NE PS_T3_Part1bNE_Test7")

# Replacing negative values by zero 

post_PS_tasks_time[post_PS_tasks_time < 0] <- 0 


# calculating the time variables 

post_PS_tasks_time <- post_PS_tasks_time %>%
  mutate(post.PS_completed_num = rowSums(post_PS_tasks_time[,2:17] !="", na.rm=TRUE),
         
         post.PS_completed_percent = post.PS_completed_num/16*100,
         
         post.PS_total_RT_sec = as.numeric(apply(post_PS_tasks_time[,2:17], 1, sum, na.rm=TRUE)),
         
         post.PS_total_RT_min = post.PS_total_RT_sec/60,
         
         post.PS_avg_RT_sec = post.PS_total_RT_sec/post.PS_completed_num,
         
         post.PS_part1_RT_sec = as.numeric(apply(post_PS_tasks_time[,2:9], 1, sum)),
         
         post.PS_part2E_RT_sec = as.numeric(apply(post_PS_tasks_time[,10:13], 1, sum)),
         
         post.PS_part2NE_RT_sec = as.numeric(apply(post_PS_tasks_time[,14:17], 1, sum)))

```




###### Reshaping the Delayed-assessment data #######

### subsetting
```{r}
delayed_math <- delayed_test[ which(delayed_test$problem_num %in% 
                              c("13_02_P", "13_03_F", "13_04_C",  
                                "13_06_F", "13_07_P", "13_08_C", "13_09_C", 
                                "13_11_P", "13_12_F", "13_13_C")), ]
```

### delayed TEST- correctness (item level)
```{r}
delayed_math_score <- dcast(delayed_math, 
                        student_id ~ problem_num, 
                        value.var = "correct", 
                        fun.aggregate = sum, na.rm = FALSE)

setnames(delayed_math_score, old=c("13_02_P", "13_03_F", "13_04_C",  
                                "13_06_F", "13_07_P", "13_08_C", "13_09_C", 
                                "13_11_P", "13_12_F", "13_13_C"), 
         
         new=c("correct.13_02_P", "correct.13_03_F", "correct.13_04_C",  
              "correct.13_06_F", "correct.13_07_P", "correct.13_08_C",
              "correct.13_09_C", "correct.13_11_P", "correct.13_12_F", "correct.13_13_C"), skip_absent=TRUE)
```


### delayedTEST- math performance 
```{r}
delayed_math_score <- delayed_math_score %>%
  mutate(delayed.total_math_score = (correct.13_02_P + correct.13_03_F + 
                                   correct.13_04_C + correct.13_06_F + 
                                   correct.13_07_P + correct.13_08_C + 
                                   correct.13_09_C + correct.13_11_P +
                                   correct.13_12_F + correct.13_13_C),
         
         delayed.percentage_math_score = (delayed.total_math_score/10)*100,
         
         delayed.sub_P_score = (correct.13_02_P + correct.13_07_P + correct.13_11_P),
         
         delayed.sub_C_score = (correct.13_04_C + correct.13_08_C +
                              correct.13_09_C + correct.13_13_C),
         
         delayed.sub_F_score = (correct.13_03_F + correct.13_06_F + correct.13_12_F)) 
```

# delayedTEST- Completion &  Time taken
```{r}
delayed_time <- dcast(delayed_test, 
                  student_id ~ problem_num, 
                  value.var = "estimated_time_on_task", 
                  fun.aggregate = sum, na.rm = FALSE)

delayed_time[delayed_time == 0] <- NA

delayed_time <- delayed_time %>% select("student_id", "13_02_P", "13_03_F", "13_04_C", 
                                "13_06_F", "13_07_P", "13_08_C", "13_09_C", 
                                "13_11_P", "13_12_F", "13_13_C")

setnames(delayed_time, old=c("13_02_P", "13_03_F", "13_04_C", 
                         "13_06_F", "13_07_P", "13_08_C", 
                         "13_09_C", "13_11_P", 
                         "13_12_F", "13_13_C"), 
         
         new=c("time_on_task.13_02_P", "time_on_task.13_03_F", "time_on_task.13_04_C", 
               "time_on_task.13_06_F", "time_on_task.13_07_P", "time_on_task.13_08_C", 
               "time_on_task.13_09_C", "time_on_task.13_11_P", 
               "time_on_task.13_12_F", "time_on_task.13_13_C"), skip_absent=TRUE)

delayed_time <- delayed_time %>%
  mutate(delayed.math_completed_num = rowSums(delayed_time[,2:11] !="", na.rm=TRUE),
         
         delayed.math_completed_percent = delayed.math_completed_num/10*100,
         
         delayed.total_time_on_tasks = as.numeric(apply(delayed_time[,2:11], 1, sum, na.rm=TRUE)),
         
         delayed.avg_time_on_tasks = delayed.total_time_on_tasks/delayed.math_completed_num)

```


# delayedTEST- PS tasks 
```{r}
### subsetting PS tasks 
delayed_PS_tasks_1_2 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test2"), ]
delayed_PS_tasks_1_4 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test4"), ]
delayed_PS_tasks_1_6 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test6"), ]
delayed_PS_tasks_1_10 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test10"), ]
delayed_PS_tasks_1_11 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test11"), ]
delayed_PS_tasks_1_12 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test12"), ]
delayed_PS_tasks_1_14 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test14"), ]
delayed_PS_tasks_1_15 <- delayed_test[ which(delayed_test$task_name=="PS_Part1_Test15"), ]

delayed_PS_tasks_2E_2 <- delayed_test[ which(delayed_test$task_part =="T4P2E" & delayed_test$task_name=="PS_T4_Part2bE_Test2"), ]
delayed_PS_tasks_2E_3 <- delayed_test[ which(delayed_test$task_part =="T4P2E" & delayed_test$task_name=="PS_T4_Part2bE_Test3"), ]
delayed_PS_tasks_2E_5 <- delayed_test[ which(delayed_test$task_part =="T4P2E" & delayed_test$task_name=="PS_T4_Part2bE_Test5"), ]
delayed_PS_tasks_2E_8 <- delayed_test[ which(delayed_test$task_part =="T4P2E" & delayed_test$task_name=="PS_T4_Part2bE_Test8"), ]

delayed_PS_tasks_2NE_1 <- delayed_test[ which(delayed_test$task_part =="T4P2NE" & delayed_test$task_name=="PS_T4_Part2bNE_Test1"), ]
delayed_PS_tasks_2NE_4 <- delayed_test[ which(delayed_test$task_part =="T4P2NE" & delayed_test$task_name=="PS_T4_Part2bNE_Test4"), ]
delayed_PS_tasks_2NE_6 <- delayed_test[ which(delayed_test$task_part =="T4P2NE" & delayed_test$task_name=="PS_T4_Part2bNE_Test6"), ]
delayed_PS_tasks_2NE_8 <- delayed_test[ which(delayed_test$task_part =="T4P2NE" & delayed_test$task_name=="PS_T4_Part2bNE_Test8"), ]


# ordering by study log id 
delayed_PS_tasks_1_2 <- delayed_PS_tasks_1_2[order(delayed_PS_tasks_1_2$study_log_id), ]
delayed_PS_tasks_1_4 <- delayed_PS_tasks_1_4[order(delayed_PS_tasks_1_4$study_log_id), ]
delayed_PS_tasks_1_6 <- delayed_PS_tasks_1_6[order(delayed_PS_tasks_1_6$study_log_id), ]
delayed_PS_tasks_1_10 <- delayed_PS_tasks_1_10[order(delayed_PS_tasks_1_10$study_log_id), ]
delayed_PS_tasks_1_11 <- delayed_PS_tasks_1_11[order(delayed_PS_tasks_1_11$study_log_id), ]
delayed_PS_tasks_1_12 <- delayed_PS_tasks_1_12[order(delayed_PS_tasks_1_12$study_log_id), ]
delayed_PS_tasks_1_14 <- delayed_PS_tasks_1_14[order(delayed_PS_tasks_1_14$study_log_id), ]
delayed_PS_tasks_1_15 <- delayed_PS_tasks_1_15[order(delayed_PS_tasks_1_15$study_log_id), ]

delayed_PS_tasks_2E_2 <- delayed_PS_tasks_2E_2[order(delayed_PS_tasks_2E_2$study_log_id), ]
delayed_PS_tasks_2E_3 <- delayed_PS_tasks_2E_3[order(delayed_PS_tasks_2E_3$study_log_id), ]
delayed_PS_tasks_2E_5 <- delayed_PS_tasks_2E_5[order(delayed_PS_tasks_2E_5$study_log_id), ]
delayed_PS_tasks_2E_8 <- delayed_PS_tasks_2E_8[order(delayed_PS_tasks_2E_8$study_log_id), ]

delayed_PS_tasks_2NE_1 <- delayed_PS_tasks_2NE_1[order(delayed_PS_tasks_2NE_1$study_log_id), ]
delayed_PS_tasks_2NE_4 <- delayed_PS_tasks_2NE_4[order(delayed_PS_tasks_2NE_4$study_log_id), ]
delayed_PS_tasks_2NE_6 <- delayed_PS_tasks_2NE_6[order(delayed_PS_tasks_2NE_6$study_log_id), ]
delayed_PS_tasks_2NE_8 <- delayed_PS_tasks_2NE_8[order(delayed_PS_tasks_2NE_8$study_log_id), ]

# Keep the FIRST ATTEMPT ONLY (distinct function: If there are duplicate rows, only the first row is delayedserved)
delayed_PS_tasks_1_2 <- delayed_PS_tasks_1_2 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_4 <- delayed_PS_tasks_1_4 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_6 <- delayed_PS_tasks_1_6 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_10 <- delayed_PS_tasks_1_10 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_11 <- delayed_PS_tasks_1_11 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_12 <- delayed_PS_tasks_1_12 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_14 <- delayed_PS_tasks_1_14 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_1_15 <- delayed_PS_tasks_1_15 %>% distinct(student_id, .keep_all = TRUE)

delayed_PS_tasks_2E_2 <- delayed_PS_tasks_2E_2 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2E_3 <- delayed_PS_tasks_2E_3 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2E_5 <- delayed_PS_tasks_2E_5 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2E_8 <- delayed_PS_tasks_2E_8 %>% distinct(student_id, .keep_all = TRUE)

delayed_PS_tasks_2NE_1 <- delayed_PS_tasks_2NE_1 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2NE_4 <- delayed_PS_tasks_2NE_4 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2NE_6 <- delayed_PS_tasks_2NE_6 %>% distinct(student_id, .keep_all = TRUE)
delayed_PS_tasks_2NE_8 <- delayed_PS_tasks_2NE_8 %>% distinct(student_id, .keep_all = TRUE)


# merge the datasets 
delayed_PS_tasks <- do.call("rbind", list(delayed_PS_tasks_1_2, delayed_PS_tasks_1_4,             
                                      delayed_PS_tasks_1_6, 
                                      delayed_PS_tasks_1_10, delayed_PS_tasks_1_11, 
                                      delayed_PS_tasks_1_12, delayed_PS_tasks_1_14, 
                                      delayed_PS_tasks_1_15, delayed_PS_tasks_2E_2, 
                                      delayed_PS_tasks_2E_3, delayed_PS_tasks_2E_5, 
                                      delayed_PS_tasks_2E_8, delayed_PS_tasks_2NE_1, 
                                      delayed_PS_tasks_2NE_4, delayed_PS_tasks_2NE_6,
                                      delayed_PS_tasks_2NE_8))


delayed_PS_tasks$task_part_name <- paste(delayed_PS_tasks$task_part, delayed_PS_tasks$task_name)

```

# delayedTEST- PS tasks score
```{r}
delayed_PS_tasks_score <- dcast(delayed_PS_tasks, 
                            student_id ~ task_part_name, 
                            value.var = "correctness", 
                            fun.aggregate = sum, na.rm = FALSE)


col_order_delayed <- c("student_id", "T4P1 PS_Part1_Test2",	"T4P1 PS_Part1_Test4",	
                 "T4P1 PS_Part1_Test6",	"T4P1 PS_Part1_Test10",	
                 "T4P1 PS_Part1_Test11",	"T4P1 PS_Part1_Test12",	
                 "T4P1 PS_Part1_Test14",	"T4P1 PS_Part1_Test15",	
                 
                 "T4P2E PS_T4_Part2bE_Test2",	"T4P2E PS_T4_Part2bE_Test3",	
                 "T4P2E PS_T4_Part2bE_Test5",	"T4P2E PS_T4_Part2bE_Test8",	
                 
                 "T4P2NE PS_T4_Part2bNE_Test1", "T4P2NE PS_T4_Part2bNE_Test4",	
                 "T4P2NE PS_T4_Part2bNE_Test6", "T4P2NE PS_T4_Part2bNE_Test8")

delayed_PS_tasks_score <- delayed_PS_tasks_score[, col_order_delayed]


delayed_PS_tasks_score <- delayed_PS_tasks_score %>%
  mutate(delayed.PS_tasks_total_score = as.numeric(apply(delayed_PS_tasks_score[,2:17], 1, sum)),
         
         delayed.PS_part1_score = as.numeric(apply(delayed_PS_tasks_score[,2:9], 1, sum)),
         
         delayed.PS_part2E_score = as.numeric(apply(delayed_PS_tasks_score[,10:13], 1, sum)),
         
         delayed.PS_part2NE_score = as.numeric(apply(delayed_PS_tasks_score[,14:17], 1, sum)))
```



# delayedTEST- PS tasks time
```{r}
delayed_PS_tasks_time <- dcast(delayed_PS_tasks, 
                           student_id ~ task_part_name,
                           value.var = "response_time", 
                           na.rm = TRUE)

delayed_PS_tasks_time <- delayed_PS_tasks_time[, col_order_delayed]


delayed_PS_tasks_time <- delayed_PS_tasks_time %>%
  rename("T4P1 PS_Part1_Test2_RT" = "T4P1 PS_Part1_Test2", 
         "T4P1 PS_Part1_Test4_RT" = "T4P1 PS_Part1_Test4",	
         "T4P1 PS_Part1_Test6_RT" = "T4P1 PS_Part1_Test6",	
         "T4P1 PS_Part1_Test10_RT" = "T4P1 PS_Part1_Test10",	
         "T4P1 PS_Part1_Test11_RT" = "T4P1 PS_Part1_Test11",	
         "T4P1 PS_Part1_Test12_RT" = "T4P1 PS_Part1_Test12",	
         "T4P1 PS_Part1_Test14_RT" = "T4P1 PS_Part1_Test14",	
         "T4P1 PS_Part1_Test15_RT" = "T4P1 PS_Part1_Test15",	
         
         "T4P2E PS_T4_Part2bE_Test2_RT" = "T4P2E PS_T4_Part2bE_Test2",	
         "T4P2E PS_T4_Part2bE_Test3_RT" = "T4P2E PS_T4_Part2bE_Test3",	
         "T4P2E PS_T4_Part2bE_Test5_RT" = "T4P2E PS_T4_Part2bE_Test5",	
         "T4P2E PS_T4_Part2bE_Test8_RT" = "T4P2E PS_T4_Part2bE_Test8",	
         
         "T4P2NE PS_T4_Part2bNE_Test1_RT" = "T4P2NE PS_T4_Part2bNE_Test1", 
         "T4P2NE PS_T4_Part2bNE_Test4_RT" = "T4P2NE PS_T4_Part2bNE_Test4",	
         "T4P2NE PS_T4_Part2bNE_Test6_RT" = "T4P2NE PS_T4_Part2bNE_Test6", 
         "T4P2NE PS_T4_Part2bNE_Test8_RT" = "T4P2NE PS_T4_Part2bNE_Test8")

# Replacing negative values by zero 

delayed_PS_tasks_time[delayed_PS_tasks_time < 0] <- 0 


# calculating the time variables 

delayed_PS_tasks_time <- delayed_PS_tasks_time %>%
  mutate(delayed.PS_completed_num = rowSums(delayed_PS_tasks_time[,2:17] !="", na.rm=TRUE),
         
         delayed.PS_completed_percent = delayed.PS_completed_num/16*100,
         
         delayed.PS_total_RT_sec = as.numeric(apply(delayed_PS_tasks_time[,2:17], 1, sum, na.rm=TRUE)),
         
         delayed.PS_total_RT_min = delayed.PS_total_RT_sec/60,
         
         delayed.PS_avg_RT_sec = delayed.PS_total_RT_sec/delayed.PS_completed_num,
         
         delayed.PS_part1_RT_sec = as.numeric(apply(delayed_PS_tasks_time[,2:9], 1, sum)),
         
         delayed.PS_part2E_RT_sec = as.numeric(apply(delayed_PS_tasks_time[,10:13], 1, sum)),
         
         delayed.PS_part2NE_RT_sec = as.numeric(apply(delayed_PS_tasks_time[,14:17], 1, sum)))


```

###### MERGE DATASETS and EXPORT ######
```{r}
ies_aggregation <- final_roster %>%
                           full_join(pre_math_score, by = "student_id") %>%
                           full_join(pre_time, by = "student_id") %>%
                           full_join(pre_MA_score, by = "student_id") %>%
                           full_join(pre_MSE_score, by = "student_id") %>%
  
                           full_join(pre_PS_tasks_score, by = 'student_id') %>%
                           full_join(pre_PS_tasks_time, by = 'student_id') %>%
  
                           full_join(mid_math_score, by = "student_id") %>%
                           full_join(mid_time, by = "student_id") %>%
                           full_join(mid_MA_score, by = "student_id") %>%
  
                           full_join(mid_PS_tasks_score, by = 'student_id') %>%
                           full_join(mid_PS_tasks_time, by = 'student_id') %>%

                           full_join(post_math_score, by = "student_id") %>%
                           full_join(post_time, by = "student_id") %>%
                           full_join(post_MA_score, by = "student_id") %>%
                           full_join(post_MSE_score, by = "student_id") %>%
  
                           full_join(post_PS_tasks_score, by = 'student_id') %>%
                           full_join(post_PS_tasks_time, by = 'student_id') %>%

                           full_join(delayed_math_score, by = "student_id") %>%
                           full_join(delayed_time, by = "student_id") %>%
                           full_join(delayed_PS_tasks_score, by = 'student_id') %>%
                           full_join(delayed_PS_tasks_time, by = 'student_id') 

```

### Filtering out the problem-level data 
```{r}
ies_aggregation_student <- ies_aggregation[ ,grepl("student_number|student_id|Condition Assignment|pre.|mid.|post.|delayed.", 
                    names(ies_aggregation))]

ies_aggregation_problem <- ies_aggregation[ ,!grepl("pre|mid.|post.|delayed.", 
                    names(ies_aggregation))]
```



# Exporting the dataset into xlsx 
```{r}
write_xlsx(x = ies_aggregation_student, 
           path = "ies_assessment_aggregation_student_20220616.xlsx", col_names = TRUE)

write_xlsx(x = ies_aggregation_problem, 
           path = "ies_assessment_aggregation_problem_20220616.xlsx", col_names = TRUE)
```
